<!-- Back Button -->
<div class="back-button">
    <a href="/deployments" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i> Back to Deployments
    </a>
</div>

<!-- Deployment Header -->
<header class="header deployment-header">
    <div class="deployment-info">
        <div class="deployment-icon">
            <i class="fas fa-cloud"></i>
        </div>
        <div>
            <h1><%= deployment.name || 'Untitled Deployment' %></h1>
            <p class="deployment-url">
                <a href="<%= deployment.url %>" target="_blank">
                    <i class="fas fa-external-link-alt"></i> <%= deployment.url %>
                </a>
                <button onclick="copyToClipboard('<%= deployment.url %>')" class="copy-btn" title="Copy URL">
                    <i class="fas fa-copy"></i>
                </button>
            </p>
            <div class="deployment-meta">
                <span class="meta-item">
                    <i class="fas fa-calendar"></i>
                    Created: <%= new Date(deployment.created_at).toLocaleDateString() %>
                </span>
                <span class="meta-item">
                    <i class="fas fa-clock"></i>
                    Expires: <%= new Date(deployment.expires_at).toLocaleDateString() %>
                    <span class="expiry-status <%= isExpired ? 'text-danger' : 'text-warning' %>">
                        (<%= getTimeRemaining(deployment.expires_at) %>)
                    </span>
                </span>
                <span class="meta-item">
                    <i class="fas fa-folder"></i>
                    Files: <%= deployment.file_count || 0 %>
                </span>
                <span class="meta-item">
                    <i class="fas fa-hdd"></i>
                    Size: <%= formatBytes(deployment.total_size || 0) %>
                </span>
            </div>
        </div>
    </div>
    <div class="deployment-actions">
        <span class="status-badge status-<%= deployment.status || 'active' %>">
            <%= deployment.status || 'active' %>
        </span>
        <a href="<%= deployment.url %>" target="_blank" class="btn btn-primary">
            <i class="fas fa-external-link-alt"></i> Visit Site
        </a>
        <button onclick="deleteDeployment('<%= deployment.id %>')" class="btn btn-danger">
            <i class="fas fa-trash"></i> Delete
        </button>
    </div>
</header>

<% if (deployment.description) { %>
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-align-left"></i> Description</h2>
    </div>
    <div class="card-body">
        <p><%= deployment.description %></p>
    </div>
</div>
<% } %>

<!-- File Browser -->
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-folder-open"></i> Files (<%= files.length %>)</h2>
        <div class="header-actions">
            <button onclick="downloadAllFiles()" class="btn btn-outline">
                <i class="fas fa-download"></i> Download All
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="file-browser">
            <% if (files && files.length > 0) { %>
                <div class="file-list">
                    <% files.forEach(file => { 
                        const icon = getFileIcon(file.file_path || file.original_name);
                        const isImage = /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(file.file_path || file.original_name);
                        const fileName = file.file_path || file.original_name;
                        const fileUrl = `${deployment.url}/${fileName}`;
                    %>
                    <div class="file-item" onclick="toggleFilePreview('<%= file.id %>', '<%= fileUrl %>', <%= isImage %>)">
                        <div class="file-icon">
                            <i class="<%= icon %>"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name"><%= fileName %></div>
                            <div class="file-meta">
                                <span><%= formatBytes(file.file_size || 0) %></span>
                                <span><%= file.mime_type || 'Unknown type' %></span>
                                <% if (file.created_at) { %>
                                <span><%= new Date(file.created_at).toLocaleDateString() %></span>
                                <% } %>
                            </div>
                        </div>
                        <div class="file-actions">
                            <a href="<%= fileUrl %>" target="_blank" class="file-action" title="Open">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <button onclick="downloadFile('<%= fileUrl %>', '<%= fileName %>')" 
                                    class="file-action" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <% }); %>
                </div>
                
                <!-- File Preview Modal -->
                <div id="filePreview" class="file-preview-modal">
                    <div class="preview-overlay" onclick="closePreview()"></div>
                    <div class="preview-container">
                        <div class="preview-header">
                            <h3 id="previewFileName"></h3>
                            <button onclick="closePreview()" class="close-btn">&times;</button>
                        </div>
                        <div class="preview-content" id="previewContent">
                            <div class="text-center" style="padding: 50px;">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p class="mt-3">Loading preview...</p>
                            </div>
                        </div>
                    </div>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h3>No Files Found</h3>
                    <p>This deployment doesn't contain any files.</p>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Deployment Logs -->
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-history"></i> Activity Log</h2>
    </div>
    <div class="card-body">
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-marker success"></div>
                <div class="timeline-content">
                    <h4>Deployment Created</h4>
                    <p><%= new Date(deployment.created_at).toLocaleString() %></p>
                </div>
            </div>
            <% if (deployment.updated_at && deployment.updated_at !== deployment.created_at) { %>
            <div class="timeline-item">
                <div class="timeline-marker info"></div>
                <div class="timeline-content">
                    <h4>Last Updated</h4>
                    <p><%= new Date(deployment.updated_at).toLocaleString() %></p>
                </div>
            </div>
            <% } %>
            <div class="timeline-item">
                <div class="timeline-marker warning"></div>
                <div class="timeline-content">
                    <h4>Scheduled Expiry</h4>
                    <p><%= new Date(deployment.expires_at).toLocaleString() %></p>
                    <small class="text-warning"><%= getTimeRemaining(deployment.expires_at) %> remaining</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
    </div>
    <div class="card-body">
        <div class="quick-actions">
            <button onclick="renewDeployment('<%= deployment.id %>')" class="quick-action-btn btn-success">
                <i class="fas fa-redo"></i>
                <span>Renew Deployment</span>
                <small>Extend expiry by 7 days</small>
            </button>
            <button onclick="cloneDeployment('<%= deployment.id %>')" class="quick-action-btn btn-primary">
                <i class="fas fa-clone"></i>
                <span>Clone Deployment</span>
                <small>Create a copy</small>
            </button>
            <button onclick="downloadZip()" class="quick-action-btn btn-warning">
                <i class="fas fa-file-archive"></i>
                <span>Download as ZIP</span>
                <small>Export all files</small>
            </button>
            <button onclick="shareDeployment()" class="quick-action-btn btn-info">
                <i class="fas fa-share-alt"></i>
                <span>Share</span>
                <small>Share deployment link</small>
            </button>
        </div>
    </div>
</div>

<style>
    .back-button {
        margin-bottom: 20px;
    }
    
    .deployment-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    .deployment-info {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }
    
    .deployment-icon {
        width: 80px;
        height: 80px;
        border-radius: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
    }
    
    .deployment-header h1 {
        font-size: 1.8rem;
        margin-bottom: 10px;
        color: #333;
    }
    
    .deployment-url {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .deployment-url a {
        color: var(--primary);
        text-decoration: none;
        font-size: 1rem;
        word-break: break-all;
    }
    
    .deployment-url a:hover {
        text-decoration: underline;
    }
    
    .copy-btn {
        background: var(--light);
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--gray);
        transition: all 0.3s;
        flex-shrink: 0;
    }
    
    .copy-btn:hover {
        background: var(--primary);
        color: white;
    }
    
    .deployment-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 10px;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--gray);
        font-size: 0.9rem;
    }
    
    .meta-item i {
        color: var(--primary);
    }
    
    .deployment-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .expiry-status {
        font-weight: 600;
        margin-left: 5px;
    }
    
    .text-danger {
        color: var(--danger) !important;
    }
    
    .text-warning {
        color: var(--warning) !important;
    }
    
    /* File Browser */
    .file-browser {
        background: white;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .file-list {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .file-item:hover {
        background: rgba(0,112,243,0.03);
    }
    
    .file-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: var(--light);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: var(--primary);
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    
    .file-details {
        flex: 1;
        min-width: 0;
    }
    
    .file-name {
        font-weight: 500;
        margin-bottom: 5px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .file-meta {
        display: flex;
        gap: 15px;
        color: var(--gray);
        font-size: 0.85rem;
    }
    
    .file-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.3s;
        flex-shrink: 0;
    }
    
    .file-item:hover .file-actions {
        opacity: 1;
    }
    
    .file-action {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        background: var(--light);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--gray);
        transition: all 0.3s;
    }
    
    .file-action:hover {
        background: var(--primary);
        color: white;
    }
    
    /* File Preview Modal */
    .file-preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
    }
    
    .file-preview-modal.active {
        display: block;
    }
    
    .preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
    }
    
    .preview-container {
        position: relative;
        max-width: 90%;
        max-height: 90vh;
        margin: 5vh auto;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        z-index: 1001;
    }
    
    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: white;
        border-bottom: 1px solid var(--border);
    }
    
    .preview-header h3 {
        margin: 0;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray);
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .preview-content {
        padding: 20px;
        max-height: calc(90vh - 70px);
        overflow: auto;
    }
    
    .preview-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
    }
    
    /* Timeline */
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border);
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 25px;
    }
    
    .timeline-marker {
        position: absolute;
        left: -24px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--success);
    }
    
    .timeline-marker.success { background: var(--success); }
    .timeline-marker.info { background: var(--primary); }
    .timeline-marker.warning { background: var(--warning); }
    
    .timeline-content {
        padding: 10px 0;
    }
    
    .timeline-content h4 {
        margin-bottom: 5px;
        color: #333;
    }
    
    .timeline-content p {
        color: var(--gray);
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    /* Quick Action Buttons */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }
    
    .quick-action-btn {
        padding: 20px;
        border: 1px solid var(--border);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        background: white;
        width: 100%;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .quick-action-btn i {
        font-size: 1.5rem;
        margin-bottom: 10px;
        display: block;
    }
    
    .quick-action-btn span {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
    }
    
    .quick-action-btn small {
        color: var(--gray);
        font-size: 0.85rem;
    }
    
    .quick-action-btn.btn-success {
        border-color: var(--success);
        color: var(--success);
    }
    
    .quick-action-btn.btn-primary {
        border-color: var(--primary);
        color: var(--primary);
    }
    
    .quick-action-btn.btn-warning {
        border-color: var(--warning);
        color: var(--warning);
    }
    
    .quick-action-btn.btn-info {
        border-color: var(--primary);
        color: var(--primary);
    }
    
    .header-actions {
        display: flex;
        gap: 10px;
    }
    
    .empty-state {
        text-align: center;
        padding: 50px 20px;
    }
    
    .empty-state i {
        font-size: 3rem;
        color: var(--gray);
        margin-bottom: 20px;
    }
    
    .empty-state h3 {
        margin-bottom: 10px;
        color: #333;
    }
    
    .empty-state p {
        color: var(--gray);
    }
</style>

<script>
// Add this to your main.js or keep here
<% function getTimeRemaining(expiryDate) {
    const now = new Date();
    const expiry = new Date(expiryDate);
    const diffMs = expiry - now;
    
    if (diffMs < 0) return 'Expired';
    
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    
    if (diffDays > 0) return `${diffDays} day${diffDays !== 1 ? 's' : ''} left`;
    if (diffHours > 0) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} left`;
    return 'Less than an hour left';
} %>

function toggleFilePreview(fileId, fileUrl, isImage) {
    const modal = document.getElementById('filePreview');
    const fileName = document.getElementById('previewFileName');
    const content = document.getElementById('previewContent');
    
    const filename = fileUrl.split('/').pop();
    fileName.textContent = filename;
    
    // Show loading state
    content.innerHTML = `
        <div class="text-center" style="padding: 50px;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3">Loading preview...</p>
        </div>
    `;
    
    modal.classList.add('active');
    
    if (isImage) {
        content.innerHTML = `<img src="${fileUrl}" alt="${filename}" onload="this.style.display='block'" style="display:none" />`;
    } else {
        fetch(fileUrl)
            .then(response => {
                if (response.headers.get('content-type')?.includes('text/')) {
                    return response.text();
                }
                throw new Error('Not a text file');
            })
            .then(text => {
                const escapedText = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                
                content.innerHTML = `
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto;">
                        <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${escapedText.substring(0, 5000)}</pre>
                    </div>
                `;
                
                if (text.length > 5000) {
                    content.innerHTML += '<p class="text-muted mt-2"><small>Preview truncated. Download to see full file.</small></p>';
                }
            })
            .catch(() => {
                content.innerHTML = `
                    <div class="text-center" style="padding: 50px;">
                        <i class="fas fa-file fa-3x text-muted"></i>
                        <p class="mt-3">No preview available for this file type.</p>
                        <a href="${fileUrl}" target="_blank" class="btn btn-primary mt-2">
                            <i class="fas fa-download"></i> Download File
                        </a>
                    </div>
                `;
            });
    }
}

function closePreview() {
    document.getElementById('filePreview').classList.remove('active');
}

function downloadFile(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

async function downloadAllFiles() {
    try {
        QuickDeploy.showLoading('Preparing download...');
        const response = await fetch(`/api/deployments/<%= deployment.id %>/download`);
        
        if (!response.ok) {
            throw new Error('Download failed');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `<%= deployment.name || 'deployment' %>.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        QuickDeploy.showToast('Download started!', 'success');
    } catch (error) {
        console.error('Download error:', error);
        QuickDeploy.showToast('Failed to download files', 'error');
    } finally {
        QuickDeploy.hideLoading();
    }
}

function downloadZip() {
    downloadAllFiles();
}

async function renewDeployment(deploymentId) {
    try {
        const confirmed = await QuickDeploy.showConfirm({
            title: 'Renew Deployment',
            message: 'Extend this deployment for 7 more days?',
            confirmText: 'Renew',
            cancelText: 'Cancel'
        });
        
        if (!confirmed) return;
        
        QuickDeploy.showLoading('Renewing deployment...');
        const data = await QuickDeploy.apiRequest(`/deployments/${deploymentId}/renew`, {
            method: 'POST'
        });
        
        if (data.success) {
            QuickDeploy.showToast('Deployment renewed for 7 days!', 'success');
            setTimeout(() => location.reload(), 1500);
        }
    } catch (error) {
        console.error('Renew error:', error);
    } finally {
        QuickDeploy.hideLoading();
    }
}

async function cloneDeployment(deploymentId) {
    try {
        const confirmed = await QuickDeploy.showConfirm({
            title: 'Clone Deployment',
            message: 'Create a copy of this deployment?',
            confirmText: 'Clone',
            cancelText: 'Cancel'
        });
        
        if (!confirmed) return;
        
        QuickDeploy.showLoading('Cloning deployment...');
        const data = await QuickDeploy.apiRequest(`/deployments/${deploymentId}/clone`, {
            method: 'POST'
        });
        
        if (data.success) {
            QuickDeploy.showToast('Deployment cloned successfully!', 'success');
            if (data.newId) {
                setTimeout(() => {
                    window.location.href = `/deployment/${data.newId}`;
                }, 1500);
            }
        }
    } catch (error) {
        console.error('Clone error:', error);
    } finally {
        QuickDeploy.hideLoading();
    }
}

function shareDeployment() {
    const url = `<%= deployment.url %>`;
    
    if (navigator.share) {
        navigator.share({
            title: '<%= deployment.name || "QuickDeploy Site" %>',
            text: 'Check out this site deployed on QuickDeploy',
            url: url
        }).catch(console.error);
    } else {
        QuickDeploy.copyToClipboard(url);
        QuickDeploy.showToast('URL copied to clipboard!', 'success');
    }
}

async function deleteDeployment(id) {
    try {
        const confirmed = await QuickDeploy.showConfirm({
            title: 'Delete Deployment',
            message: 'Are you sure you want to delete this deployment? This action cannot be undone.',
            confirmText: 'Delete',
            cancelText: 'Cancel',
            type: 'danger'
        });
        
        if (!confirmed) return;
        
        QuickDeploy.showLoading('Deleting deployment...');
        const data = await QuickDeploy.apiRequest(`/deployments/${id}`, {
            method: 'DELETE'
        });
        
        if (data.success) {
            QuickDeploy.showToast('Deployment deleted successfully!', 'success');
            setTimeout(() => {
                window.location.href = '/deployments';
            }, 1500);
        }
    } catch (error) {
        console.error('Delete error:', error);
    } finally {
        QuickDeploy.hideLoading();
    }
}

// Close preview when pressing Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closePreview();
    }
});
</script>