<!-- Back Button -->
<div class="back-button">
    <a href="/deployments" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i> Back to Deployments
    </a>
</div>

<!-- Deployment Header -->
<header class="header deployment-header">
    <div class="deployment-info">
        <div class="deployment-icon">
            <i class="fas fa-cloud"></i>
        </div>
        <div>
            <h1><%= deployment.name || 'Untitled Deployment' %></h1>
            <p class="deployment-url">
                <a href="<%= deployment.url %>" target="_blank">
                    <i class="fas fa-external-link-alt"></i> <%= deployment.url %>
                </a>
                <button onclick="copyToClipboard('<%= deployment.url %>')" class="copy-btn" title="Copy URL">
                    <i class="fas fa-copy"></i>
                </button>
            </p>
            <div class="deployment-meta">
                <span class="meta-item">
                    <i class="fas fa-calendar"></i>
                    Created: <%= new Date(deployment.created_at).toLocaleString() %>
                </span>
                <span class="meta-item">
                    <i class="fas fa-clock"></i>
                    Expires: <%= new Date(deployment.expires_at).toLocaleString() %>
                </span>
                <span class="meta-item">
                    <i class="fas fa-folder"></i>
                    Files: <%= deployment.file_count %>
                </span>
                <span class="meta-item">
                    <i class="fas fa-hdd"></i>
                    Size: <%= (deployment.total_size / 1024).toFixed(2) %> KB
                </span>
            </div>
        </div>
    </div>
    <div class="deployment-actions">
        <span class="status-badge status-<%= deployment.status || 'active' %>">
            <%= deployment.status || 'active' %>
        </span>
        <a href="<%= deployment.url %>" target="_blank" class="btn btn-primary">
            <i class="fas fa-external-link-alt"></i> Visit Site
        </a>
        <button onclick="deleteDeployment('<%= deployment.id %>')" class="btn btn-danger">
            <i class="fas fa-trash"></i> Delete
        </button>
    </div>
</header>

<% if (deployment.description) { %>
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-align-left"></i> Description</h2>
    </div>
    <div class="card-body">
        <p><%= deployment.description %></p>
    </div>
</div>
<% } %>

<!-- File Browser -->
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-folder-open"></i> Files (<%= files.length %>)</h2>
        <button onclick="downloadAllFiles()" class="btn btn-outline">
            <i class="fas fa-download"></i> Download All
        </button>
    </div>
    <div class="card-body">
        <div class="file-browser">
            <% if (files && files.length > 0) { %>
                <div class="file-list">
                    <% files.forEach(file => { 
                        const icon = getFileIcon(file.file_path);
                        const isImage = /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(file.file_path);
                        const fileUrl = `${deployment.url}/${file.file_path.replace(deploymentPath + '/', '')}`;
                    %>
                    <div class="file-item" onclick="toggleFilePreview('<%= file.id %>', '<%= fileUrl %>', <%= isImage %>)">
                        <div class="file-icon">
                            <i class="<%= icon %>"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name"><%= file.file_path.split('/').pop() %></div>
                            <div class="file-meta">
                                <span><%= (file.file_size / 1024).toFixed(2) %> KB</span>
                                <span><%= new Date(file.created_at).toLocaleDateString() %></span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <a href="<%= fileUrl %>" target="_blank" class="file-action" title="Open">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <button onclick="downloadFile('<%= fileUrl %>', '<%= file.file_path.split('/').pop() %>')" 
                                    class="file-action" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <% }); %>
                </div>
                
                <!-- File Preview Modal -->
                <div id="filePreview" class="file-preview-modal">
                    <div class="preview-header">
                        <h3 id="previewFileName"></h3>
                        <button onclick="closePreview()" class="close-btn">&times;</button>
                    </div>
                    <div class="preview-content" id="previewContent">
                        <!-- Preview content will be loaded here -->
                    </div>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h3>No Files Found</h3>
                    <p>This deployment doesn't contain any files.</p>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Deployment Logs -->
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-history"></i> Activity Log</h2>
    </div>
    <div class="card-body">
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-marker success"></div>
                <div class="timeline-content">
                    <h4>Deployment Created</h4>
                    <p><%= new Date(deployment.created_at).toLocaleString() %></p>
                </div>
            </div>
            <% if (deployment.updated_at && deployment.updated_at !== deployment.created_at) { %>
            <div class="timeline-item">
                <div class="timeline-marker info"></div>
                <div class="timeline-content">
                    <h4>Last Updated</h4>
                    <p><%= new Date(deployment.updated_at).toLocaleString() %></p>
                </div>
            </div>
            <% } %>
            <div class="timeline-item">
                <div class="timeline-marker warning"></div>
                <div class="timeline-content">
                    <h4>Scheduled Expiry</h4>
                    <p><%= new Date(deployment.expires_at).toLocaleString() %></p>
                    <small class="text-warning"><%= getTimeRemaining(deployment.expires_at) %> remaining</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
    </div>
    <div class="card-body">
        <div class="quick-actions">
            <button onclick="renewDeployment('<%= deployment.id %>')" class="quick-action-btn btn-success">
                <i class="fas fa-redo"></i>
                <span>Renew Deployment</span>
                <small>Extend expiry by 7 days</small>
            </button>
            <button onclick="cloneDeployment('<%= deployment.id %>')" class="quick-action-btn btn-primary">
                <i class="fas fa-clone"></i>
                <span>Clone Deployment</span>
                <small>Create a copy</small>
            </button>
            <button onclick="downloadZip('<%= deployment.id %>')" class="quick-action-btn btn-warning">
                <i class="fas fa-file-archive"></i>
                <span>Download as ZIP</span>
                <small>Export all files</small>
            </button>
            <button onclick="shareDeployment('<%= deployment.id %>')" class="quick-action-btn btn-info">
                <i class="fas fa-share-alt"></i>
                <span>Share</span>
                <small>Share deployment link</small>
            </button>
        </div>
    </div>
</div>

<style>
    .back-button {
        margin-bottom: 20px;
    }
    
    .deployment-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    .deployment-info {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }
    
    .deployment-icon {
        width: 80px;
        height: 80px;
        border-radius: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
    }
    
    .deployment-header h1 {
        font-size: 1.8rem;
        margin-bottom: 10px;
        color: #333;
    }
    
    .deployment-url {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .deployment-url a {
        color: var(--primary);
        text-decoration: none;
        font-size: 1rem;
    }
    
    .deployment-url a:hover {
        text-decoration: underline;
    }
    
    .copy-btn {
        background: var(--light);
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--gray);
        transition: all 0.3s;
    }
    
    .copy-btn:hover {
        background: var(--primary);
        color: white;
    }
    
    .deployment-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 10px;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--gray);
        font-size: 0.9rem;
    }
    
    .meta-item i {
        color: var(--primary);
    }
    
    .deployment-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    /* File Browser */
    .file-browser {
        background: white;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .file-list {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .file-item:hover {
        background: rgba(0,112,243,0.03);
    }
    
    .file-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: var(--light);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: var(--primary);
        font-size: 1.2rem;
    }
    
    .file-details {
        flex: 1;
    }
    
    .file-name {
        font-weight: 500;
        margin-bottom: 5px;
        color: #333;
    }
    
    .file-meta {
        display: flex;
        gap: 15px;
        color: var(--gray);
        font-size: 0.85rem;
    }
    
    .file-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .file-item:hover .file-actions {
        opacity: 1;
    }
    
    .file-action {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        background: var(--light);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--gray);
        transition: all 0.3s;
    }
    
    .file-action:hover {
        background: var(--primary);
        color: white;
    }
    
    /* File Preview Modal */
    .file-preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
    }
    
    .file-preview-modal.active {
        display: block;
    }
    
    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: white;
    }
    
    .preview-header h3 {
        margin: 0;
        color: #333;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: var(--gray);
    }
    
    .preview-content {
        padding: 20px;
        background: white;
        max-width: 90%;
        max-height: 80vh;
        margin: 20px auto;
        border-radius: 10px;
        overflow: auto;
    }
    
    .preview-content img {
        max-width: 100%;
        height: auto;
    }
    
    /* Timeline */
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border);
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 25px;
    }
    
    .timeline-marker {
        position: absolute;
        left: -24px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--success);
    }
    
    .timeline-marker.success { background: var(--success); }
    .timeline-marker.info { background: var(--primary); }
    .timeline-marker.warning { background: var(--warning); }
    
    .timeline-content {
        padding: 10px 0;
    }
    
    .timeline-content h4 {
        margin-bottom: 5px;
        color: #333;
    }
    
    .timeline-content p {
        color: var(--gray);
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    /* Quick Action Buttons */
    .quick-action-btn {
        padding: 25px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        display: block;
        width: 100%;
    }
    
    .quick-action-btn i {
        font-size: 1.8rem;
        margin-bottom: 15px;
        display: block;
    }
    
    .quick-action-btn span {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
    }
    
    .quick-action-btn small {
        color: var(--gray);
        font-size: 0.85rem;
    }
    
    .btn-info { background: rgba(0,112,243,0.1); color: var(--primary); }
    .btn-info:hover { background: var(--primary); color: white; }
</style>

<script>
function getFileIcon(filePath) {
    const ext = filePath.split('.').pop().toLowerCase();
    const icons = {
        html: 'fas fa-code',
        css: 'fab fa-css3-alt',
        js: 'fab fa-js-square',
        json: 'fas fa-file-code',
        md: 'fas fa-file-alt',
        txt: 'fas fa-file-alt',
        pdf: 'fas fa-file-pdf',
        zip: 'fas fa-file-archive',
        jpg: 'fas fa-file-image',
        jpeg: 'fas fa-file-image',
        png: 'fas fa-file-image',
        gif: 'fas fa-file-image',
        svg: 'fas fa-file-image',
        webp: 'fas fa-file-image',
        mp4: 'fas fa-file-video',
        mp3: 'fas fa-file-audio'
    };
    return icons[ext] || 'fas fa-file';
}

function toggleFilePreview(fileId, fileUrl, isImage) {
    const modal = document.getElementById('filePreview');
    const fileName = document.getElementById('previewFileName');
    const content = document.getElementById('previewContent');
    
    // Get filename from URL
    const filename = fileUrl.split('/').pop();
    fileName.textContent = filename;
    
    if (isImage) {
        content.innerHTML = `<img src="${fileUrl}" alt="${filename}" />`;
    } else {
        // For text files, fetch and display content
        content.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>`;
        fetch(fileUrl)
            .then(response => response.text())
            .then(text => {
                content.innerHTML = `<pre>${escapeHtml(text.substring(0, 5000))}</pre>`;
                if (text.length > 5000) {
                    content.innerHTML += '<p class="text-muted">Preview truncated. Download to see full file.</p>';
                }
            })
            .catch(() => {
                content.innerHTML = '<p>Unable to preview this file type.</p>';
            });
    }
    
    modal.classList.add('active');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function closePreview() {
    document.getElementById('filePreview').classList.remove('active');
}

function downloadFile(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function downloadAllFiles() {
    fetch(`/api/deployments/<%= deployment.id %>/download`)
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `<%= deployment.name || 'deployment' %>-<%= deployment.id %>.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });
}

function downloadZip(deploymentId) {
    downloadAllFiles();
}

function renewDeployment(deploymentId) {
    fetch(`/api/admin/renew/${deploymentId}`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success('Deployment renewed for 7 days');
            setTimeout(() => location.reload(), 1000);
        }
    });
}

function cloneDeployment(deploymentId) {
    if (confirm('Create a copy of this deployment?')) {
        fetch(`/api/deployments/${deploymentId}/clone`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                toastr.success('Deployment cloned successfully');
                setTimeout(() => {
                    window.location.href = `/deployment/${data.newId}`;
                }, 1500);
            }
        });
    }
}

function shareDeployment(deploymentId) {
    const url = `<%= deployment.url %>`;
    if (navigator.share) {
        navigator.share({
            title: '<%= deployment.name || "Check out this site" %>',
            text: 'Check out this deployed site',
            url: url
        });
    } else {
        copyToClipboard(url);
        toastr.success('URL copied to clipboard!');
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        toastr.success('Copied to clipboard!');
    });
}

function deleteDeployment(id) {
    if (confirm('Are you sure you want to delete this deployment?')) {
        fetch(`/api/deployments/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                toastr.success('Deployment deleted successfully');
                setTimeout(() => {
                    window.location.href = '/deployments';
                }, 1000);
            } else {
                toastr.error(data.error || 'Failed to delete deployment');
            }
        });
    }
}

function getTimeRemaining(expiryDate) {
    const now = new Date();
    const expiry = new Date(expiryDate);
    const diffMs = expiry - now;
    
    if (diffMs < 0) return 'Expired';
    
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    
    if (diffDays > 0) return `${diffDays} days ${diffHours} hours remaining`;
    if (diffHours > 0) return `${diffHours} hours remaining`;
    return 'Less than an hour remaining';
}
</script>